# Description: Store all the functions for graph plotting and data visualization
# Project:     R Shiny Climate Statistics 
# Ownership:   Meteorological Services of Canada - MSC
# Author:      Chris Jing
# Created on:  2019-10-08

# Load the source R codes
source("M:/My documents/R_Shiny/R_Script_Suite/cleanData.R", print=TRUE)
#source("/home/jingc/shiny-server/F2F_sample/helper_functions/cleanData.R", print=TRUE)

# T_min and T_max Color Code 
blue <- "#0000FF"
red <- "#FF0000"
light_blue <- "#1E90FF"
light_red  <- "#B22222"

# Monthly Time Series Color Code
jan_color <- "#0066FF"; feb_color <- "#00FFFF"; mar_color <- "#66FFCC"; apr_color <- "#66FF66"
may_color <- "#CCFF66"; jun_color <- "#FFFF66"; jul_color <- "#FFCC66"; aug_color <- "#FF6666"
sep_color <- "#FF66CC"; oct_color <- "#FF66FF"; nov_color <- "#CC66FF"; dec_color <- "#6666FF"
black <- "#000000"
mean_color <- "#32CD32" # lime green

monthly_labels <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", 
                    "Sep", "Oct", "Nov", "Dec", "Annual Mean", "Trend Line")
monthly_values <- c("Jan"=jan_color, "Feb"=feb_color, "Mar"=mar_color, "Apr"=apr_color, "May"=may_color,
                    "Jun"=jun_color, "Jul"=jul_color, "Aug"=aug_color, "Sep"=sep_color, "Oct"=oct_color,
                    "Nov"=nov_color, "Dec"=dec_color, "Annual Mean"=mean_color, "Trend Line"=red)

#  -----------------------------------  #
# |                                   | #
# | I. TIME SERIES PLOTTING FUNCTIONS | #
# |                                   | #
#  -----------------------------------  #

# FUNCTION #P1-01
# Purpose: This function plots the maximum and minimum temperature time series 
#          for any selected Virtual Station in Canada
# Inputs: df [R data frame]  - the data table that stores the temperature time series
#         vrtStn [character] - the name of the virtual station to display in the plot
#         ymin [double]      - the lower bound of the y-axis (temperature)
#         ymax [double]      - the upper bound of the y-axis (temperature)
#         ybreak [double]    - the spacing interval of the y-axis (temperature)
#         xmin [integer]     - the lower bound of the x-axis (year; e.g. 1896)
#         xmax [integer]     - the upper bound of the x-axis (year; e.g. 2019)
#         xbreak [character] - the spacing interval between adjacent ticks (e.g. "5 years")
#         Tmax [boolean]     - if true, include the daily maximum temperature time series in the plot
#         Tmin [boolean]     - if true, include the daily minimum temperature time series in the plot
#         trend [boolean]    - if true, include the trend line 
#         eqn [boolean]      - if true, include the equation for the trend line 
# Output: A plot of the maximum and minimum daily temperature time series 
plotTempTimeSeries <- function(df, vrtStn, ymin, ymax, ybreak, xmin, xmax, xbreak, Tmax, Tmin, Tmean, trend, eqn) {
  # Case 1: upper and lower bound matches (Plot for single year time series only)
  if(xmin==xmax) {
    dot_size = 2; dot_shape = 16; x_date_break = "1 month"; x_date_labels = "%Y-%b-%d"; xmin_date=paste(as.character(xmin), "-01-01", sep="")
    
    # This year's data (let end date be yesterday)
    if(xmax==max(df$LOCAL_YEAR, na.rm=TRUE)) { 
      xmax_date=as.Date(max(df$LOCAL_TIME, na.rm=TRUE), format="%Y-%m-%d")
    }
    
    # Other year's data (let end date be December 31)
    else{ 
      xmax_date=paste(as.character(xmax), "-12-31", sep="")
    }
  }
  
  # Case 2: plot based on the upper and lower bound for x-axis
  else{
    dot_size = 1; dot_shape = 1; x_date_labels = "%Y"
    
    if(xmin==min(df$LOCAL_YEAR, na.rm=TRUE)){
      xmin_date=as.Date(min(df$LOCAL_TIME, na.rm=TRUE), format="%Y-%m-%d")
    }
    else{
      xmin_date=paste(as.character(xmin), "-01-01", sep="")
    }
    if(xmax==max(df$LOCAL_YEAR, na.rm=TRUE)){
      xmax_date=as.Date(max(df$LOCAL_TIME, na.rm=TRUE), format="%Y-%m-%d")
    }
    else{
      xmax_date=paste(as.character(xmax), "-12-31", sep="")
    }
    
    # Adjust x-axis scale size
    if(xmax-xmin > 50){
      x_date_break = "5 years"
    }
    else if(xmax-xmin > 20){
      x_date_break = "2 years"
    }
    else if(xmax-xmin > 1){
      x_date_break = "1 year"
    }
    else{
      x_date_break = "1 month"
    }
    
  }
  
  # Check for the type of plot: T_min & T_max, T_min only, T_max only, or T_mean only
  if(Tmax==TRUE && Tmin==TRUE) {
    yData1 <- df$MAX_TEMPERATURE; yData2 <- df$MIN_TEMPERATURE
    typeData=c("Daily Maximum", "Daily Minimum"); colorCode=c(light_red, light_blue)
    
    newPlot <- ggplot(data=df, aes(x=as.Date(LOCAL_TIME, format="%Y-%m-%d"))) + 
      geom_point_interactive(aes(y = MAX_TEMPERATURE,color="Daily Maximum", onclick=MAX_TEMPERATURE), shape=dot_shape, size=dot_size) + 
      geom_point_interactive(aes(y = MIN_TEMPERATURE, color="Daily Minimum", onclick=MIN_TEMPERATURE), shape=dot_shape, size=dot_size) +
      labs(title=paste("Daily Maximum and Minimum Temperature Time Series for", vrtStn, sep=" "), 
           subtitle=paste("Record from", xmin_date, "to", xmax_date, sep=" "), 
           x="Time (date)", y="Temperature (?C)", 
           colour="Data Index", caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_date(date_labels = x_date_labels, date_breaks = x_date_break, limits=c(as.Date(xmin_date),as.Date(xmax_date))) + 
      scale_y_continuous(limits = c(ymin, ymax), breaks = seq(from=ymin, to=ymax, by=ybreak))
  }
  
  else if(Tmin==TRUE) {
    yData <- df$MIN_TEMPERATURE
    typeData="Daily Minimum"; colorCode=light_blue
    
    newPlot <- ggplot(data=df, aes(x=as.Date(LOCAL_TIME, format="%Y-%m-%d"))) + 
      geom_point_interactive(aes(y = MIN_TEMPERATURE, color="Daily Minimum", onclick=MIN_TEMPERATURE), shape=dot_shape, size=dot_size) +
      labs(title=paste("Daily Minimum Temperature Time Series for", vrtStn, sep=" "), 
           subtitle=paste("Record from", xmin_date, "to", xmax_date, sep=" "), 
           x="Time (date)", y="Temperature (?C)", colour="Data Index",
           caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_date(date_labels = x_date_labels, date_breaks = x_date_break, limits=c(as.Date(xmin_date),as.Date(xmax_date))) + 
      scale_y_continuous(limits = c(ymin, ymax), breaks = seq(from=ymin, to=ymax, by=ybreak))
  }
  
  else if(Tmax==TRUE) {
    yData <- df$MAX_TEMPERATURE
    typeData="Daily Maximum"; colorCode=light_red
    
    newPlot <- ggplot(data=df, aes(x=as.Date(LOCAL_TIME, format="%Y-%m-%d"))) + 
      geom_point_interactive(aes(y = MAX_TEMPERATURE, color="Daily Maximum", onclick=MAX_TEMPERATURE), shape=dot_shape, size=dot_size) +
      labs(title=paste("Daily Maximum Temperature Time Series for", vrtStn, sep=" "), 
           subtitle=paste("Record from", xmin_date, "to", xmax_date, sep=" "), 
           x="Time (date)", y="Temperature (?C)", colour="Data Index",
           caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_date(date_labels = x_date_labels, date_breaks = x_date_break, limits=c(as.Date(xmin_date),as.Date(xmax_date))) + 
      scale_y_continuous(limits = c(ymin, ymax), breaks = seq(from=ymin, to=ymax, by=ybreak))
  }
  
  else {
    yData <- df$MEAN_TEMPERATURE
    typeData="Daily Mean"; colorCode=mean_color 
    
    newPlot <- ggplot(data=df, aes(x=as.Date(LOCAL_TIME, format="%Y-%m-%d"))) + 
      geom_point_interactive(aes(y = (MAX_TEMPERATURE+MIN_TEMPERATURE)/2, colour="Daily Mean", onclick=(MAX_TEMPERATURE+MIN_TEMPERATURE)/2), shape=dot_shape, size=dot_size) +
      labs(title=paste("Daily Mean Temperature Time Series for", vrtStn, sep=" "), 
           subtitle=paste("Record from", xmin_date, "to", xmax_date, sep=" "), 
           x="Time (date)", y="Temperature (?C)", colour="Data Index",
           caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_date(date_labels = x_date_labels, date_breaks = x_date_break, limits=c(as.Date(xmin_date),as.Date(xmax_date))) + 
      scale_y_continuous(limits = c(ymin, ymax), breaks = seq(from=ymin, to=ymax, by=ybreak))
  }
  
  if(trend==TRUE) {
    if(Tmax==TRUE && Tmin==TRUE) {
      newPlot <- newPlot + 
        geom_smooth(aes(y=yData1,color="Trend Line"), method="lm", formula=y ~ x, se=FALSE, size= 0.5) +
        geom_smooth(aes(y=yData2,color="Trend Line"), method="lm", formula=y ~ x, se=FALSE, size= 0.5) +
        scale_color_manual(labels = c("Daily Maximum", "Daily Minimum", "Trend Line", "Trend Line"), 
                           values = c(light_red, light_blue, black, black))
    }
    else{
      if(eqn==FALSE){
        newPlot <- newPlot + 
          geom_smooth(aes(y=yData,color="Trend Line"), method="lm", formula=y ~ x, se=FALSE, size= 0.5) +
          scale_color_manual(labels = c(typeData, "Trend Line"), values = c(colorCode, black)) 
      }
      else{
        newPlot <- newPlot +
          geom_smooth(aes(y=yData,color="Trend Line"), method="lm", formula=y ~ x, se=FALSE, size= 0.5) + 
          stat_poly_eq(formula = y ~ x, aes(y=yData, label = paste(stat(eq.label), stat(adj.rr.label), sep = "~~~~")), parse = TRUE,
                                          label.y = "bottom", label.x = "right", show.legend=FALSE) + 
          scale_color_manual(labels = c(typeData, "Trend Line"), values = c(colorCode, black)) 
      }
    }
  }
  else{
    newPlot <- newPlot + scale_color_manual(labels = c(typeData), values = c(colorCode)) 
  }
  return(newPlot)
}


# FUNCTION #P1-02
# Purpose: This function plots the mean annual temperature (in Celcisus) vs time (in years) 
#         for a chosen virtial station (by name) with a linear fit trend line.
#         User has the option of including 12 monthly time series. 
# Inputs:df [R data frame]    - the data table that stores the temperature time series
#        vrtStn [character]   - the name of the virtual station (e.g "Vancouver Area")
#        ymin [integer]       - the lower bound of the y-axis (degrees; e.g. -10)
#        ymax [integer]       - the upper bound of the y-axis (degrees; e.g. 30)
#        ybreak [integer]     - the spacing interval of the y-axis (degrees; e.g. 2)
#        xmin [integer]       - the lower bound of the x-axis (year, e.g. 1896)
#        xmax [integer]       - the upper bound of the x-axis (year; e.g. 2019)
#        xbreak [integer]     - the spacing interval between adjacent ticks (years; e.g. 5)
#        meanOnly [boolean]   - FALSE to include the 12 monthly time series, TRUE otherwise
#        extreme_N [integer]  - number of data points (with the most extreme values) to highlight
# Output: A plot of annual mean temperatures vs years in history 
plotAnnualMeanTempTimeSeries <- function(df, vrtStn, ymin, ymax, ybreak, xmin, xmax, xbreak, meanOnly, extreme_N) {
  
  linear.fit.formula <- y ~ x
  
  # Case 1: Full plot with both monthly and annual mean data (with a trend line)
  if(meanOnly == FALSE) {
    newPlot <- ggplot(data=df, aes(x=LOCAL_YEAR)) + 
      geom_line(aes(y=JAN, color=monthly_labels[1]), size=1) + 
      geom_line(aes(y=FEB, color=monthly_labels[2]), size=1) +
      geom_line(aes(y=MAR, color=monthly_labels[3]), size=1) + 
      geom_line(aes(y=APR, color=monthly_labels[4]), size=1) + 
      geom_line(aes(y=MAY, color=monthly_labels[5]), size=1) + 
      geom_line(aes(y=JUN, color=monthly_labels[6]), size=1) + 
      geom_line(aes(y=JUL, color=monthly_labels[7]), size=1) +
      geom_line(aes(y=AUG, color=monthly_labels[8]), size=1) + 
      geom_line(aes(y=SEP, color=monthly_labels[9]), size=1) + 
      geom_line(aes(y=OCT, color=monthly_labels[10]), size=1)+ 
      geom_line(aes(y=NOV, color=monthly_labels[11]), size=1)+ 
      geom_line(aes(y=DEC, color=monthly_labels[12]), size=1)+ 
      geom_line(aes(y=ANNUAL_MEAN, color=monthly_labels[13]), size=1, linetype="dotted") + 
      geom_point(aes(y=ANNUAL_MEAN, color=monthly_labels[13]), show.legend=FALSE, shape=18, size=2) +
      geom_smooth(aes(y=ANNUAL_MEAN,color="Trend Line"), 
                  method="lm", formula=y ~ x, se=FALSE, size= 0.5)  +
      
      labs(title=paste("Annual Mean Temperature Time Series for", vrtStn, sep=" "), 
           subtitle=paste("Record from", xmin, "to", xmax, sep=" "), 
           x="Time (year)", y="Temperature (?C)", colour="Month Index", 
           caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_continuous(limits = c(xmin, xmax), breaks = seq(from=xmin, to=xmax, by=xbreak)) + 
      scale_y_continuous(limits = c(ymin, ymax), breaks = seq(from=ymin, to=ymax, by=ybreak)) +
      scale_color_manual(labels=monthly_labels, breaks=monthly_labels,values=monthly_values) +
      stat_poly_eq(formula = linear.fit.formula, 
                   aes(y=ANNUAL_MEAN, label = paste(stat(eq.label), stat(adj.rr.label), sep = "~~~~")), 
                   parse = TRUE, label.y = "bottom", label.x = "right") 
  }
  
  # Case 2: Only plot the annual mean data (with a trend line) with top and bottom N extremes highlighted
  else {
    newPlot <- ggplot(data=df, aes(x=LOCAL_YEAR)) + 
      geom_point(aes(y=ANNUAL_MEAN, color="Annual Mean"), shape=18, size=2) +
      geom_line(aes(y=ANNUAL_MEAN, color="Annual Mean"), show.legend=FALSE, size=1, linetype="dotted") + 
      geom_smooth(aes(y=ANNUAL_MEAN,color="Trend Line"), 
                  method="lm", formula=y ~ x, se=FALSE, size= 0.5) +
  
      labs(title=paste("Annual Mean Temperature Time Series for", vrtStn, sep=" "), 
           subtitle=paste("Record from", xmin, "to", xmax, sep=" "), 
           x="Time (year)", y="Temperature (?C)", colour="Legend",
           caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_continuous(limits = c(xmin, xmax), breaks = seq(from=xmin, to=xmax, by=xbreak)) + 
      scale_y_continuous(limits = c(floor(min(df$ANNUAL_MEAN, na.rm=TRUE)-3), ceiling(max(df$ANNUAL_MEAN, na.rm=TRUE)+3)), 
                         breaks = seq(from=floor((min(df$ANNUAL_MEAN, na.rm=TRUE)-3)), to=(ceiling(max(df$ANNUAL_MEAN, na.rm=TRUE)+3)), by=ybreak))+
      scale_color_manual(labels=c("Annual Mean", "Trend Line", "Top Ranked", "Bottom Ranked"), 
                         breaks=c("Annual Mean", "Trend Line", "Top Ranked", "Bottom Ranked"),
                         values=c("Annual Mean"=mean_color, "Trend Line"=red, "Top Ranked"=red, "Bottom Ranked"=blue))+
      stat_poly_eq(formula = linear.fit.formula, 
                   aes(y=ANNUAL_MEAN, label = paste(stat(eq.label), stat(adj.rr.label), sep = "~~~~")), parse = TRUE,
                   label.y = "bottom", label.x = "right") +
      geom_text(aes(y=ANNUAL_MEAN, colour="Top Ranked",  label=ifelse((RANK<=extreme_N), as.character(paste(LOCAL_YEAR, "\n", ANNUAL_MEAN, "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE) + 
      geom_text(aes(y=ANNUAL_MEAN, colour="Bottom Ranked", label=ifelse((RANK>nrow(na.omit(df))-extreme_N), as.character(paste(LOCAL_YEAR, "\n", ANNUAL_MEAN, "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE)
    }
  return(newPlot)
}





#  ------------------------------------------  #
# |                                          | #
# |  II. CLIMATE EXTREMES PLOTTING FUNCTIONS | #
# |                                          | #
#  ------------------------------------------  #

# FUNCTION #P2-01
# Purpose: This function plots the climate extreme values vs dates in a year for a virtual station 
# Inputs:df [R data frame]    - the data table that stores the temperature time series
#                               (see output of FUNCTION #C1-02 in cleanData as an example)
#        vrtStn [character]   - the name of the virtual station (e.g "Vancouver Area")
#        type [character]     - the type of extreme data 
#                             ("highest maximum", "lowest maximum", "highest minimum", or "lowest minimum")
#        ymin [integer]       - the lower bound of the y-axis (degrees; e.g. -10)
#        ymax [integer]       - the upper bound of the y-axis (degrees; e.g. 30)
#        ybreak [integer]     - the spacing interval of the y-axis (degrees; e.g. 2)
#        rank [boolean]       - TRUE if rank the extreme values when plotting
#        extreme_N [integer]  - number of data points (with the most extreme values) to highlight
#        year_min [integer]       - the lower bound of the record year (e.g. 1896)
#        year_max [integer]       - the upper bound of the record year (e.g. 2019)
# Output: A plot of climate extreme values vs dates in a year 
plotExtreme <- function(df, vrtStn, type, ymin, ymax, ybreak, rank, extreme_N, year_min, year_max){
  ranked_df <- df[with(df, order(df %>% select(matches("RANK")))),]
  timed_df  <- df[with(df, order(df %>% select(matches("LOCAL_TIME")))),]
  
  # check for the type of extreme data
  if(type=="Highest Maximum"){
    valueColumnName = "RECORD_HIGH_MAX_TEMP"
    yearColumnName  = "RECORD_HIGH_MAX_TEMP_YR"
    colorName       = "Record High Maximum"
    colorValue      = red
    highest_rank    = 1; lowest_rank = 366
  }
  else if(type=="Lowest Maximum"){
    valueColumnName = "RECORD_LOW_MAX_TEMP"
    yearColumnName  = "RECORD_LOW_MAX_TEMP_YR"
    colorName       = "Record Low Maximum"
    colorValue      = light_red
    highest_rank    = 366; lowest_rank = 1
  }
  else if(type=="Highest Minimum"){
    valueColumnName = "RECORD_HIGH_MIN_TEMP"
    yearColumnName  = "RECORD_HIGH_MIN_TEMP_YR"
    colorName       = "Record High Minimum"
    colorValue      = light_blue
    highest_rank    = 1; lowest_rank = 366
  }
  else if(type=="Lowest Minimum"){
    valueColumnName = "RECORD_LOW_MIN_TEMP"
    yearColumnName  = "RECORD_LOW_MIN_TEMP_YR"
    colorName       = "Record Low Minimum"
    colorValue      = blue
    highest_rank    = 366; lowest_rank = 1
  }
  else{}
  
  df <- df[(df[,8]>=year_min & df[,8]<=year_max),]
  
  # Case 1: ranking not required
  if(rank==FALSE){
    newPlot <- ggplot(data=df, aes(x=as.Date(paste("2000-", as.character(LOCAL_MONTH), "-", as.character(LOCAL_DAY), sep="")))) + 
      geom_point(aes(y = df[, valueColumnName], color=colorName), shape=16, size=1) +
      labs(title=paste("Daily Climate Extremes for", vrtStn, sep=" "), 
           subtitle=paste("Earliest Extreme: ", as.character(format(timed_df[1, valueColumnName])), "?C on ",
                          as.character(format(timed_df[1, "LOCAL_TIME"], format="%Y-%m-%d")),
                          "; Latest Extreme: ", as.character(format(timed_df[366, valueColumnName])), "?C on ",
                          as.character(format(timed_df[366, "LOCAL_TIME"], format="%Y-%m-%d")), "\n",
                          "Highest Extreme: ", as.character(max(df[, valueColumnName])), "?C on ", as.character(format(ranked_df[highest_rank, "LOCAL_TIME"], format="%Y-%m-%d")),
                          "; Lowest Extreme: ", as.character(min(df[, valueColumnName])),"?C on ", as.character(format(ranked_df[lowest_rank, "LOCAL_TIME"], format="%Y-%m-%d")), sep=""), 
           x="Date (in any given year)", y="Temperature (?C)", 
           colour="Data Index", caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_date(limits=c(as.Date("2000-01-01"),as.Date("2000-12-31")), date_labels = "%b %d", breaks =seq(as.Date("2000-01-01"), as.Date("2000-12-31"), "1 month")) +
      scale_y_continuous(limits = c(ymin, ymax), breaks = seq(from=ymin, to=ymax, by=ybreak)) + 
      scale_color_manual(labels = colorName, values = colorValue) +
      geom_text(aes(y=df[,valueColumnName], color=colorName, label=ifelse((RANK<=extreme_N), as.character(paste(df[, yearColumnName], "\n", df[, valueColumnName], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE) 
  }
  
  # Case 2: ranking required
  else{
    newPlot <- ggplot(data=df, aes(x=RANK)) + 
      geom_point(aes(y = df[, valueColumnName], color=colorName), shape=21, size=2) +
      labs(title=paste("Daily Climate Extremes for", vrtStn, sep=" "), 
           subtitle=paste("Earliest Extreme: ", as.character(format(timed_df[1, valueColumnName])), "?C on ",
                          as.character(format(timed_df[1, "LOCAL_TIME"], format="%Y-%m-%d")),
                          "; Latest Extreme: ", as.character(format(timed_df[366, valueColumnName])), "?C on ",
                          as.character(format(timed_df[366, "LOCAL_TIME"], format="%Y-%m-%d")), "\n",
                          "Highest Extreme: ", as.character(max(df[, valueColumnName])), "?C on ", as.character(format(ranked_df[highest_rank, "LOCAL_TIME"], format="%Y-%m-%d")),
                          "; Lowest Extreme: ", as.character(min(df[, valueColumnName])),"?C on ", as.character(format(ranked_df[lowest_rank, "LOCAL_TIME"], format="%Y-%m-%d")), sep=""), 
           x="Ranking Result (out of 366 days)", y="Temperature (?C)", 
           colour="Data Index", caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_continuous(limits = c(1, 366), breaks = seq(from=1, to=366, by=15)) +
      scale_y_continuous(limits = c(ymin, ymax), breaks = seq(from=ymin, to=ymax, by=ybreak)) + 
      scale_color_manual(labels = colorName, values =colorValue) +
      geom_text(aes(y=df[,valueColumnName], color=colorName, label=ifelse((RANK<=extreme_N), as.character(paste(df[, yearColumnName], "\n", df[, valueColumnName], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE) 
  }
  return(newPlot)
}


# FUNCTION #P2-03
# Purpose: Same as function #P2-02, except it plots all four data sets on the same graph
# Inputs:con [OraConnection]  - the connection between R and Arkeon 
#        vrtStn [character]   - the name of the virtual station (e.g "Vancouver Area")
#                             ("highest maximum", "lowest maximum", "highest minimum", or "lowest minimum")
#        ymin [integer]       - the lower bound of the y-axis (degrees; e.g. -10)
#        ymax [integer]       - the upper bound of the y-axis (degrees; e.g. 30)
#        ybreak [integer]     - the spacing interval of the y-axis (degrees; e.g. 2)
#        rank [boolean]       - if TRUE, plot as ranked temperatures
#        year_min [integer]   - the lower bound of the record year (e.g. 1896)
#        year_max [integer]   - the upper bound of the record year (e.g. 2019)
# Output: A plot of climate extreme values vs dates in a year 
plotAllExtremes <- function(con, vrtStn, ymin, ymax, ybreak, rank, year_min, year_max){
  
  valueColumnNames <- c("RECORD_HIGH_MAX_TEMP", "RECORD_LOW_MAX_TEMP", "RECORD_HIGH_MIN_TEMP", "RECORD_LOW_MIN_TEMP")
  yearColumnNames <- c("RECORD_HIGH_MAX_TEMP_YR", "RECORD_LOW_MAX_TEMP_YR", "RECORD_HIGH_MIN_TEMP_YR", "RECORD_LOW_MIN_TEMP_YR")
  colorNames <- c("Record High Maximum", "Record Low Maximum", "Record High Minimum", "Record Low Minimum")
  colorValues <- c("Record High Maximum"=red, "Record Low Maximum"=light_red, "Record High Minimum"=light_blue, "Record Low Minimum"=blue)
  
  df_high_max <- T_extreme_order_by_date(con, "Highest Maximum", TRUE, vrtStn)
  df_low_max <- T_extreme_order_by_date(con, "Lowest Maximum", FALSE, vrtStn)
  df_high_min <- T_extreme_order_by_date(con, "Highest Minimum", TRUE, vrtStn)
  df_low_min <- T_extreme_order_by_date(con, "Lowest Minimum", FALSE, vrtStn)
  
  df_high_max <- df_high_max[(df_high_max[,8]>=year_min & df_high_max[,8]<=year_max),]
  df_low_max <-  df_low_max[(df_low_max[,8]>=year_min & df_low_max[,8]<=year_max),]
  df_high_min <- df_high_min[(df_high_min[,8]>=year_min & df_high_min[,8]<=year_max),]
  df_low_min <-  df_low_min[(df_low_min[,8]>=year_min & df_low_min[,8]<=year_max),]
  
  
  timed_df_high_max <- df_high_max[with(df_high_max, order(df_high_max %>% select(matches("LOCAL_TIME")))),]
  timed_df_low_max  <- df_low_max[with(df_low_max, order(df_low_max %>% select(matches("LOCAL_TIME")))),]
  timed_df_high_min <- df_high_min[with(df_high_min, order(df_high_min %>% select(matches("LOCAL_TIME")))),]
  timed_df_low_min  <- df_low_min[with(df_low_min, order(df_low_min %>% select(matches("LOCAL_TIME")))),]
  
  ranked_df_high_max <- df_high_max[with(df_high_max, order(df_high_max %>% select(matches("RANK")))),]
  ranked_df_low_max <- df_low_max[with(df_low_max, order(df_low_max %>% select(matches("RANK")))),]
  ranked_df_high_min <- df_high_min[with(df_high_min, order(df_high_min %>% select(matches("RANK")))),]
  ranked_df_low_min <- df_low_min[with(df_low_min, order(df_low_min %>% select(matches("RANK")))),]
  
  
  # Case 1: ranking not required
  if(rank==FALSE){
    newPlot <- ggplot(data=timed_df_high_max, aes(x=as.Date(paste("2000-", as.character(LOCAL_MONTH), "-", as.character(LOCAL_DAY), sep="")))) + 
       geom_point(data=timed_df_high_max, aes(y = timed_df_high_max[, valueColumnNames[1]], color=colorNames[1]), shape=16, size=1) +
       geom_point(data=timed_df_low_max, aes(y = timed_df_low_max[, valueColumnNames[2]], color=colorNames[2]), shape=16, size=1) +
       geom_point(data=timed_df_high_min, aes(y = timed_df_high_min[, valueColumnNames[3]], color=colorNames[3]), shape=16, size=1) +
       geom_point(data=timed_df_low_min, aes(y = timed_df_low_min[, valueColumnNames[4]], color=colorNames[4]), shape=16, size=1) +
      
      labs(title=paste("Daily Temperature Extremes for", vrtStn, sep=" "), 
           subtitle=paste("Highest Maximum Ever Recorded: ", as.character(max(timed_df_high_max[, valueColumnNames[1]])), "?C on ",
                          as.character(format(ranked_df_high_max[1, "LOCAL_TIME"], format="%Y-%m-%d")),
                          "; Lowest Maximum Ever Recorded: ", as.character(min(timed_df_low_max[, valueColumnNames[2]])), "?C on ",
                          as.character(format(ranked_df_low_max[1, "LOCAL_TIME"], format="%Y-%m-%d")), "\n",
                          "Highest Minimum Ever Recorded: ", as.character(max(timed_df_high_min[, valueColumnNames[3]])), "?C on ", 
                          as.character(format(ranked_df_high_min[1, "LOCAL_TIME"], format="%Y-%m-%d")),
                          "; Lowest Minimum Ever Recorded: ", as.character(min(timed_df_low_min[, valueColumnNames[4]])),"?C on ", 
                          as.character(format(ranked_df_low_min[1, "LOCAL_TIME"], format="%Y-%m-%d"))),
           x="Date (in any given year)", y="Temperature (?C)", 
           colour="Data Index", caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_date(limits=c(as.Date("2000-01-01"),as.Date("2000-12-31")), date_labels = "%b %d", breaks =seq(as.Date("2000-01-01"), as.Date("2000-12-31"), "1 month")) +
      scale_y_continuous(limits = c(ymin, ymax), breaks = seq(from=ymin, to=ymax, by=ybreak)) + 
      scale_color_manual(labels = colorNames, breaks= colorNames, values = colorValues) + 
      geom_text(aes(x=as.Date(paste("2000-", as.character(ranked_df_high_max[1, "LOCAL_MONTH"]), "-", as.character(ranked_df_high_max[1, "LOCAL_DAY"]), sep="")),
                    y=ranked_df_high_max[1,valueColumnNames[1]], color=colorNames[1], label=ifelse((RANK==1), as.character(paste(ranked_df_high_max[1, yearColumnNames[1]], "\n", 
                    ranked_df_high_max[1, valueColumnNames[1]], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE) +
      geom_text(aes(x=as.Date(paste("2000-", as.character(ranked_df_low_max[1, "LOCAL_MONTH"]), "-", as.character(ranked_df_low_max[1, "LOCAL_DAY"]), sep="")),
                    y=ranked_df_low_max[1,valueColumnNames[2]], color=colorNames[2], label=ifelse((RANK==366), as.character(paste(ranked_df_low_max[1, yearColumnNames[2]], "\n", 
                    ranked_df_low_max[1, valueColumnNames[2]], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE) +
      geom_text(aes(x=as.Date(paste("2000-", as.character(ranked_df_high_min[1, "LOCAL_MONTH"]), "-", as.character(ranked_df_high_min[1, "LOCAL_DAY"]), sep="")),
                    y=ranked_df_high_min[1,valueColumnNames[3]], color=colorNames[3], label=ifelse((RANK==1), as.character(paste(ranked_df_high_min[1, yearColumnNames[3]], "\n", 
                    ranked_df_high_min[1, valueColumnNames[3]], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE) +
      geom_text(aes(x=as.Date(paste("2000-", as.character(ranked_df_low_min[1, "LOCAL_MONTH"]), "-", as.character(ranked_df_low_min[1, "LOCAL_DAY"]), sep="")),
                    y=ranked_df_low_min[1,valueColumnNames[4]], color=colorNames[4], label=ifelse((RANK==366), as.character(paste(ranked_df_low_min[1, yearColumnNames[4]], "\n", 
                    ranked_df_low_min[1, valueColumnNames[4]], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE)
      
    }
  
  # Case 2: ranking required
  else{
    
    newPlot <- ggplot(data=ranked_df_high_max, aes(x=seq(from=1, to=366, by=1))) + 
      geom_point(aes(y = ranked_df_high_max[, valueColumnNames[1]], color=colorNames[1]), shape=21, size=2) +
      geom_point(aes(y = ranked_df_low_max[, valueColumnNames[2]], color=colorNames[2]), shape=21, size=2) +
      geom_point(aes(y = ranked_df_high_min[, valueColumnNames[3]], color=colorNames[3]), shape=21, size=2) +
      geom_point(aes(y = ranked_df_low_min[, valueColumnNames[4]], color=colorNames[4]), shape=21, size=2) +
      
      labs(title=paste("Ranked Daily Temperature Extremes for", vrtStn, sep=" "), 
           subtitle=paste("Highest Maximum Ever Recorded: ", as.character(max(timed_df_high_max[, valueColumnNames[1]])), "?C on ",
                          as.character(format(ranked_df_high_max[1, "LOCAL_TIME"], format="%Y-%m-%d")),
                          "; Lowest Maximum Ever Recorded: ", as.character(min(timed_df_low_max[, valueColumnNames[2]])), "?C on ",
                          as.character(format(ranked_df_low_max[1, "LOCAL_TIME"], format="%Y-%m-%d")), "\n",
                          "Highest Minimum Ever Recorded: ", as.character(max(timed_df_high_min[, valueColumnNames[3]])), "?C on ", 
                          as.character(format(ranked_df_high_min[1, "LOCAL_TIME"], format="%Y-%m-%d")),
                          "; Lowest Minimum Ever Recorded: ", as.character(min(timed_df_low_min[, valueColumnNames[4]])),"?C on ", 
                          as.character(format(ranked_df_low_min[1, "LOCAL_TIME"], format="%Y-%m-%d"))),
           x="Ranking Result (out of 366 days)", y="Temperature (?C)", 
           colour="Data Index", caption=paste("(based on data extracted from MSC Arkeon-LTCE Database as of ", Sys.Date(), ")", sep="")) + 
      scale_x_continuous(limits = c(1, 366), breaks = seq(from=1, to=366, by=15)) +
      scale_y_continuous(limits = c(ymin, ymax), breaks = seq(from=ymin, to=ymax, by=ybreak)) + 
      scale_color_manual(labels = colorNames, breaks= colorNames, values =colorValues) +
      geom_text(aes(y=ranked_df_high_max[1,valueColumnNames[1]], color=colorNames[1], label=ifelse((RANK==1), as.character(paste(format(ranked_df_high_max[1, "LOCAL_TIME"], format="%b-%d"), "\n", 
                 ranked_df_high_max[1, valueColumnNames[1]], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE) +
      geom_text(aes(y=ranked_df_low_max[1,valueColumnNames[2]], color=colorNames[2], label=ifelse((RANK==1), as.character(paste(format(ranked_df_low_max[1, "LOCAL_TIME"], format="%b-%d"), "\n", 
                 ranked_df_low_max[1, valueColumnNames[2]], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE) +
      geom_text(aes(y=ranked_df_high_min[1,valueColumnNames[3]], color=colorNames[3], label=ifelse((RANK==1), as.character(paste(format(ranked_df_high_min[1, "LOCAL_TIME"], format="%b-%d"), "\n", 
                 ranked_df_high_min[1, valueColumnNames[3]], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE) +
      geom_text(aes(y=ranked_df_low_min[1,valueColumnNames[4]], color=colorNames[4], label=ifelse((RANK==1), as.character(paste(format(ranked_df_low_min[1, "LOCAL_TIME"], format="%b-%d"), "\n", 
                 ranked_df_low_min[1, valueColumnNames[4]], "?C", sep="")), '')), hjust=0, vjust=0, show.legend=FALSE)
  }
  return(newPlot)
}


#  --------------------------------------  #
# |                                      | #
# |  III. PLOTTING AESTHETIC FUNCTIONS   | #
# |                                      | #
#  --------------------------------------  #

# FUNCTION #P3-01
# Purpose: This function plots the climate extreme values vs dates in a year for a virtual station 
# Inputs: str_in [character]    - a character string specifying the parameter to be plotted
# Output: str_out [character]   - a character string specifying the text label to be displayed
textLabel <- function(str_in) {
  if(str_in=="Temperature") {
    str_out="y-axis: Temperature Range (?C)"
  }
  else if(str_in=="Precipitation") {
    str_out="y-axis: Precipitation Amount (mm)"
  }
  else if(str_in=="Wind") {
    str_out="y-axis: Wind Speed Range (km/h)"
  }
  else if(str_in=="Snow") {
    str_out="y-axis: Snow Amount (cm)"
  }
  else{
    str_out="y-axis: Unknown Parameter Range"
  }
  return(str_out)
}
